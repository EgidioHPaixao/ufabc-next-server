language: node_js

node_js:
  - "9.11.2"

services:
  - redis-server

env:
  global:
    - CI="travis"
    - MONGODB=4.0.1

before_script:
  - wget http://fastdl.mongodb.org/linux/mongodb-linux-x86_64-${MONGODB}.tgz -O /tmp/mongodb.tgz
  - tar -xvf /tmp/mongodb.tgz
  - mkdir /tmp/data
  - ${PWD}/mongodb-linux-x86_64-${MONGODB}/bin/mongod --dbpath /tmp/data --bind_ip 127.0.0.1 --auth &> /dev/null &

cache:
  directories:
    - node_modules
    - $HOME/.npm

jobs:
  include:
    - stage: test
      before_install: cd app
      install: yarn install
      script: yarn coverage
      after_script: cd ../
    - stage: deploy_test
    - stage: deploy
      if: branch = master
      install: yarn install
      script: yarn deploy -h https://captain.sv.ufabcnext.com -a api -p $PASSWORD -b master